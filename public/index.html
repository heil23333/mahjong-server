<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ï¸ é›€ç¥æ¦œ</title>
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/isoWeek.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/isoWeekYear.js"></script>
    <script src="https://unpkg.com/chart.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --card: #ffffff; --text: #334155; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px 80px 15px; max-width: 900px; margin: 0 auto; 
        }
        .container { display: flex; flex-direction: column; gap: 16px; }
        .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; overflow: hidden; }
        h2 { margin: 0 0 12px 0; color: #1e293b; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .app-title { text-align: center; margin: 5px 0 15px 0; font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #adminPanel { display: none; border-left: 4px solid var(--primary); }
        textarea { width: 100%; height: 70px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; resize: vertical; margin-bottom: 10px; box-sizing: border-box; font-family: monospace; transition: 0.2s; background: #f8fafc; }
        textarea:focus { outline: none; border-color: var(--primary); background: #fff; ring: 2px solid rgba(59, 130, 246, 0.2); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; font-weight: 500; }
        .btn:active { transform: scale(0.96); }
        .btn.outline { background: white; border: 1px solid #cbd5e1; color: var(--text); }
        .btn.outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .footer-bar { margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; padding-top: 20px; border-top: 1px dashed #cbd5e1; }
        .footer-btn { font-size: 0.8rem; color: #64748b; background: white; border: 1px solid #e2e8f0; padding: 6px 14px; border-radius: 20px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .footer-info { font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; background: #f1f5f9; padding: 4px 10px; border-radius: 12px; }

        .time-nav { display: flex; align-items: center; background: #f8fafc; padding: 4px; border-radius: 10px; gap: 6px; border: 1px solid #e2e8f0; justify-content: space-between; }
        .current-date-display { font-size: 0.85rem; font-weight: 700; color: var(--primary); text-align: center; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-btn { background: transparent; border: none; cursor: pointer; padding: 4px 8px; color: #64748b; font-weight: bold; font-size: 1.1rem; border-radius: 6px; flex-shrink: 0; }
        .nav-btn:hover { background: #e2e8f0; color: var(--primary); }
        .filter-select { appearance: none; -webkit-appearance: none; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 5px 24px 5px 10px; font-size: 0.85rem; color: #475569; font-weight: 600; cursor: pointer; outline: none; flex-shrink: 0; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 4px center; background-size: 14px; transition: all 0.2s; }

        .chart-container { position: relative; height: 280px; width: 100%; margin-top: 20px; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -16px; padding: 0 16px 10px 16px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 5px; min-width: 600px; }
        th { text-align: center; color: #94a3b8; font-weight: 600; font-size: 0.8rem; padding: 10px 6px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; background: var(--card); }
        td { padding: 14px 6px; border-bottom: 1px solid #f8fafc; font-size: 0.9rem; vertical-align: middle; text-align: center; white-space: nowrap; background: var(--card); }
        
        th:nth-child(1), td:nth-child(1) { 
            text-align: left; white-space: normal; max-width: 120px; min-width: 90px;
            position: sticky; left: 0; z-index: 2; 
            background-color: var(--card);
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
            border-right: 1px solid #f1f5f9;
        }
        th:nth-child(6), td:nth-child(6) { text-align: left; }
        
        .score { font-family: 'SF Mono', 'Roboto Mono', monospace; font-weight: 700; font-size: 0.95rem; }
        .pos { color: #ef4444; }
        .neg { color: #10b981; }
        .clickable-name { cursor: pointer; color: var(--primary); font-weight: 600; display: inline-block; margin-right: 4px; transition: 0.2s; }
        .clickable-name:hover { opacity: 0.8; text-decoration: underline; }

        /* å¾½ç«  */
        .s-tag { display: inline-block; position: relative; overflow: hidden; font-size: 0.65rem; line-height: 1; padding: 3px 6px; border-radius: 4px; color: #fff; font-weight: 800; box-shadow: 0 1px 2px rgba(0,0,0,0.1); vertical-align: middle; transform: skewX(-10deg); z-index: 1; margin-top: 2px; margin-right: 4px; }
        .s-tag span { display: inline-block; transform: skewX(10deg); position: relative; z-index: 2; }
        .s-static::after { display: none !important; }
        .s-static { animation: none !important; box-shadow: none !important; opacity: 0.9; margin-left: 0; }
        
        .s-lv2 { background: linear-gradient(135deg, #94a3b8, #64748b); border-bottom: 2px solid #334155; }
        .s-lv3 { background: linear-gradient(135deg, #f59e0b, #d97706); border-bottom: 2px solid #b45309; }
        .s-lv4 { background: linear-gradient(135deg, #fb923c, #ea580c); border-bottom: 2px solid #c2410c; }
        .s-lv5 { background: linear-gradient(135deg, #f87171, #dc2626); border-bottom: 2px solid #991b1b; }
        .s-lv6 { background: linear-gradient(135deg, #a78bfa, #7c3aed); border-bottom: 2px solid #5b21b6; }
        .s-god { background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%); border-bottom: 2px solid #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.8); animation: borderPulse 1.5s infinite alternate; z-index: 5; }
        .l-lv2 { background: linear-gradient(135deg, #e5e7eb, #9ca3af); border-bottom: 2px solid #6b7280; color: #374151; }
        .l-lv3 { background: linear-gradient(135deg, #86efac, #22c55e); border-bottom: 2px solid #15803d; }
        .l-lv4 { background: linear-gradient(135deg, #67e8f9, #06b6d4); border-bottom: 2px solid #0e7490; }
        .l-lv5 { background: linear-gradient(135deg, #4c1d95, #2e1065); border-bottom: 2px solid #0f172a; }
        .l-god { background: #000; border-bottom: 2px solid #dc2626; color: #ef4444; animation: glitch 0.5s infinite; }
        .tag-god { background: linear-gradient(135deg, #fcd34d, #f59e0b); border-bottom: 2px solid #b45309; color: #fff; }
        .tag-noob { background: linear-gradient(135deg, #10b981, #059669); border-bottom: 2px solid #047857; color: #fff; }
        .tag-worker { background: linear-gradient(135deg, #3b82f6, #2563eb); border-bottom: 2px solid #1e40af; color: #fff; }
        .tag-fish { background: linear-gradient(135deg, #94a3b8, #64748b); border-bottom: 2px solid #475569; color: #fff; }
        .s-lv3::after, .s-lv4::after, .s-lv5::after, .s-lv6::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0) 100%); transform: skewX(-20deg); z-index: 1; animation: sheen 3s infinite; }
        .s-god::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 50%, rgba(255,255,255,0) 100%); transform: skewX(-20deg); z-index: 1; animation: sheen 1.2s infinite; }
        @keyframes borderPulse { 0% { box-shadow: 0 0 4px rgba(251, 191, 36, 0.6); } 100% { box-shadow: 0 0 14px rgba(251, 191, 36, 1); } }
        @keyframes glitch { 0% { transform: skewX(-10deg) translate(0); } 20% { transform: skewX(-10deg) translate(-2px, 2px); } 80% { transform: skewX(-10deg) translate(2px, -2px); } 100% { transform: skewX(-10deg) translate(0); } }
        @keyframes sheen { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        .hist-rec { font-size: 0.75rem; color: #64748b; margin-top: 2px; display: flex; gap: 8px; align-items: center; }
        .record-item { display: flex; flex-direction: column; gap: 8px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .record-meta { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
        .del-record-btn { background: transparent; border: none; cursor: pointer; color: #cbd5e1; font-size: 1.1rem; padding: 0 5px; margin-left: 5px; transition: 0.2s; }
        .del-record-btn:hover { color: #ef4444; transform: scale(1.1); }
        .action-btn { background: transparent; border: none; cursor: pointer; color: #cbd5e1; font-size: 1.1rem; padding: 0 5px; margin-left: 5px; transition: 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .edit-btn:hover { color: var(--primary); }
        
        .player-tags { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .p-tag { background: #fff; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; border: 1px solid #e2e8f0; display: inline-flex; align-items: center; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .pagination { display: flex; justify-content: center; gap: 10px; align-items: center; margin-top: 15px; }
        .page-input { width: 36px; text-align: center; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        .page-total { color: #64748b; font-size: 0.9rem; }
        .tag-offline { background: #f3e8ff; color: #9333ea; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; border: 1px solid #e9d5ff; display: inline-flex; align-items: center; gap: 3px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 24px; border-radius: 20px; width: 90%; max-width: 380px; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.25); animation: modalPop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        @keyframes modalPop { 0% { transform: scale(0.95) translateY(10px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        .modal-hero { text-align: center; margin-bottom: 20px; }
        .modal-icon { font-size: 3rem; margin-bottom: 10px; display: inline-block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin: 0; }
        .modal-desc { color: #64748b; font-size: 0.9rem; margin-top: 5px; line-height: 1.4; word-break: break-all; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-bottom: 20px; box-sizing: border-box; transition: 0.2s; background: #f8fafc; }
        .modal-input:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .modal-btns { display: flex; gap: 10px; }
        .alias-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .alias-row input { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; }
        .del-btn { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .manual-row { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; }
        .manual-row input { padding: 10px 8px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; min-width: 0; }
        .manual-row .name { flex: 5; }
        .manual-row .score { flex: 3; text-align: center; font-family: monospace; font-weight: bold; }
        .manual-row .del-btn { width: 34px; height: 34px; flex-shrink: 0; }
        .sum-check { text-align: center; margin-top: 15px; font-size: 0.9rem; color: #64748b; font-weight: 600; padding: 8px; background: #f1f5f9; border-radius: 8px; }
        .sum-check.error { color: #ef4444; background: #fee2e2; }
        .sum-check.ok { color: #10b981; background: #dcfce7; }

        /* ğŸ”¥ v8.26: å¸ƒå±€ç³»ç»Ÿ ğŸ”¥ */
        .stat-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-grid-compact { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        
        .stat-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 4px; border-radius: 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 60px; }
        .stat-box.clickable { cursor: pointer; transition: 0.2s; border-color: #bfdbfe; background: #eff6ff; }
        .stat-box.clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: var(--primary); }
        
        /* é»˜è®¤æ ·å¼ï¼šä¸Šä¸‹å±…ä¸­ (ç”¨äºé¡¶éƒ¨å•å±€çºªå½•) */
        .stat-label { font-size: 0.7rem; color: #64748b; margin-bottom: 2px; font-weight: 600; }
        .stat-val { font-size: 1.1rem; font-weight: 800; color: #334155; font-family: monospace; }
        .stat-val.pos { color: #ef4444; }
        .stat-val.neg { color: #10b981; }

        /* ğŸ”¥ v8.26: å·¦å³å¸ƒå±€å¡ç‰‡ (å·¦æ ‡é¢˜ï¼Œå³æ•°æ®) ğŸ”¥ */
        /* è¿™ä¸ªç±»ç”¨äºæ‰€æœ‰ä¸‹æ–¹å¡ç‰‡ï¼Œå®ç° text-align: left å’Œ right çš„å¯¹æ¯” */
        .stat-box-row { 
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 10px; border-radius: 10px; 
            display: flex; flex-direction: row; justify-content: space-between; align-items: center; min-height: 42px; /* è¿›ä¸€æ­¥è°ƒçŸ® */
        }
        
        /* å·¦ä¾§æ ‡é¢˜ */
        .stat-box-row .stat-label { margin-bottom: 0; text-align: left; font-size: 0.65rem; }
        
        /* å³ä¾§æ•°æ® (é»˜è®¤æ°´å¹³å±…ä¸­) */
        .stat-box-row .stat-val { font-size: 0.95rem; line-height: 1; }
        
        /* ç‰¹æ®Šï¼šå•æ—¥æ•°æ® (å³ä¾§å‚ç›´å †å ) */
        .stat-data-group { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .stat-data-group .stat-val { font-size: 1.1rem; }
        .stat-sub { font-size: 0.6rem; color: #94a3b8; margin-top: 2px; font-family: monospace; }
        
        .divider { border-top: 1px dashed #cbd5e1; margin-top: 15px; margin-bottom: 5px; position: relative; }
        .divider::after { content: 'è¯¦ç»†æ•°æ®'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 0 8px; font-size: 0.7rem; color: #94a3b8; font-weight: 700; }
        .divider-text { text-align: center; font-size: 0.75rem; color: #94a3b8; font-weight: 700; margin-top: 15px; border-top: 1px dashed #cbd5e1; padding-top: 8px; }
        
        .badge-list { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-top: 8px; }
        .threshold-config { border-top: 1px dashed #cbd5e1; margin-top: 15px; padding-top: 10px; display: none; }
        .config-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 0.8rem; color: #475569; }
        .config-input { width: 50px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.8rem; }
        
        .match-card-header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #cbd5e1; }
        .match-date { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .match-room { color: #64748b; font-size: 0.85rem; margin-top: 4px; }
        .match-player-list { display: flex; flex-direction: column; gap: 8px; }
        .match-player-row { display: flex; justify-content: space-between; padding: 10px; border-radius: 8px; background: #f8fafc; border: 1px solid #e2e8f0; font-weight: 600; }
        .match-player-row.focus { border: 2px solid var(--primary); background: #eff6ff; }
        
        .box-god { background: #fffbeb; border-color: #fcd34d; } .box-god .honor-val { color: #d97706; }
        .box-noob { background: #ecfdf5; border-color: #6ee7b7; } .box-noob .honor-val { color: #059669; }
        .box-worker { background: #eff6ff; border-color: #93c5fd; } .box-worker .honor-val { color: #2563eb; }
        .box-fish { background: #f1f5f9; border-color: #cbd5e1; } .box-fish .honor-val { color: #475569; }
        .box-bigwin { background: #fef2f2; border-color: #fca5a5; } .box-bigwin .honor-val { color: #dc2626; }
        .box-bigloss { background: #f0fdfa; border-color: #5eead4; } .box-bigloss .honor-val { color: #0f766e; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:10px; color:#64748b; font-weight:500">æ­£åœ¨åŒæ­¥æ•°æ®...</div>
</div>

<div class="container">
    <div id="error-banner"></div>
    <h1 class="app-title">é›€ç¥æ¦œ</h1>

    <div class="card" id="adminPanel">
        <h2 style="font-size:1rem; margin-bottom:10px; opacity:0.8">ğŸ› ï¸ ç®¡ç†å‘˜æ“ä½œ</h2>
        <textarea id="rawInput" placeholder="åœ¨æ­¤ç²˜è´´æˆ˜ç»©æ–‡æœ¬..."></textarea>
        <div class="btn-toolbar">
            <button class="btn" id="uploadBtn" onclick="tryAction(safeHandleImport)">ğŸ“¥ è¯†åˆ«å¹¶å¯¼å…¥</button>
            <button class="btn" onclick="tryAction(openManualAddModal)">âœï¸ æ‰‹åŠ¨å½•å…¥</button>
            <button class="btn outline" onclick="tryAction(toggleAliasModal)">ğŸ‘¥ è®¾ç½®åˆ«å</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h2>æˆ˜ç»©èµ°åŠ¿</h2>
            <div class="time-nav">
                <button class="nav-btn" onclick="changeDate(-1)">â®</button>
                <span id="dateDisplay" class="current-date-display">...</span>
                <button class="nav-btn" onclick="changeDate(1)">â¯</button>
                <select id="timeFilterSelect" class="filter-select" onchange="onFilterChange(this.value)">
                    <option value="day">ğŸ“… æ—¥</option>
                    <option value="week" selected>ğŸ“… å‘¨</option>
                    <option value="month">ğŸ“… æœˆ</option>
                    <option value="year">ğŸ“… å¹´</option>
                    <option value="all">â™¾ï¸ å…¨</option>
                </select>
            </div>
        </div>
        <div id="statsTable"></div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>å†å²æ˜ç»† <span id="totalCount" style="font-size:0.85rem; font-weight:normal; color:#64748b"></span></h2>
        <div id="historyList"></div>
        <div class="pagination">
            <button class="btn outline" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
            <div>
                <input type="number" id="pageInput" class="page-input" value="1" onchange="jumpToPage()" onkeyup="if(event.key==='Enter') jumpToPage()">
                <span class="page-total"> / <span id="totalPagesText">1</span> é¡µ</span>
            </div>
            <button class="btn outline" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div class="footer-bar">
        <div id="loginArea">
            <button class="footer-btn" onclick="openLoginModal('admin')">ğŸ”‘ ç®¡ç†å‘˜ç™»å½•</button>
        </div>
        <div id="adminControls" style="display:none; gap:10px">
            <span class="footer-info">ğŸ‘® ç®¡ç†å‘˜æ¨¡å¼</span>
            <button class="footer-btn" onclick="doLogout()" style="color:#ef4444; border-color:#fca5a5">é€€å‡º</button>
        </div>
    </div>
</div>

<div id="manualAddModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-hero">
            <h3 class="modal-title" id="manualModalTitle">âœï¸ æ‰‹åŠ¨å½•å…¥æˆ˜ç»©</h3>
        </div>
        <input type="hidden" id="editRecordId">
        <div style="margin-bottom:15px">
            <label style="font-size:0.85rem; color:#64748b; font-weight:600">æ¯”èµ›æ—¶é—´</label>
            <input type="datetime-local" id="manualDate" class="modal-input" style="margin-bottom:5px">
        </div>
        <div style="margin-bottom:15px">
            <label style="font-size:0.85rem; color:#64748b; font-weight:600">æˆ¿é—´ä¿¡æ¯</label>
            <input type="text" id="manualRoomId" class="modal-input" placeholder="ä¾‹å¦‚: 123456 æˆ– Manual" value="Manual">
        </div>
        <div id="manualPlayerList"></div>
        <button class="btn outline" style="width:100%; border-style:dashed; margin-top:10px" onclick="addManualRow()">+ æ·»åŠ ç©å®¶</button>
        <div id="manualSumCheck" class="sum-check ok">å½“å‰æ€»åˆ†: 0</div>
        <div class="modal-btns" style="margin-top:20px">
            <button class="btn" style="flex:1" onclick="submitManualAdd()">ä¿å­˜</button>
            <button class="btn outline" style="flex:1" onclick="document.getElementById('manualAddModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
    <datalist id="playerOptions"></datalist>
</div>

<div id="playerDetailModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 380px;">
        <div style="text-align:center; position:relative; margin-bottom:10px">
            <button style="position:absolute; right:0; top:-10px; background:none; border:none; font-size:1.2rem; color:#94a3b8; cursor:pointer" onclick="closePlayerDetail()">âœ•</button>
            <div id="pd-name" style="font-size:1.4rem; font-weight:800; color:#1e293b;">Player</div>
            <div id="pd-total" style="font-size:1rem; color:#64748b; font-family:monospace;">Total: 0</div>
        </div>

        <div class="stat-grid-2" style="margin-top:0">
            <div class="stat-box clickable" onclick="openMatchDetail('win')">
                <span class="stat-label">ğŸ† æœ€é«˜å•å±€</span>
                <span id="pd-max-win" class="stat-val pos">0</span>
            </div>
            <div class="stat-box clickable" onclick="openMatchDetail('loss')">
                <span class="stat-label">â˜ ï¸ æœ€æƒ¨å•å±€</span>
                <span id="pd-max-loss" class="stat-val neg">0</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="stat-grid-compact">
            <div class="stat-box-row">
                <span class="stat-label">â˜€ï¸ æœ€çˆ½å•æ—¥</span>
                <div class="stat-data-group" id="pd-best-day">
                    <span class="stat-val">-</span>
                    <span class="stat-sub">-</span>
                </div>
            </div>
            <div class="stat-box-row">
                <span class="stat-label">ğŸŒ§ï¸ æœ€æƒ¨å•æ—¥</span>
                <div class="stat-data-group" id="pd-worst-day">
                    <span class="stat-val">-</span>
                    <span class="stat-sub">-</span>
                </div>
            </div>
            
            <div class="stat-box-row">
                <span class="stat-label">ğŸŒŸ å¤§èµ¢å®¶(ç‹¬èµ¢)</span>
                <span id="pd-big-win" class="stat-val">0æ¬¡</span>
            </div>
             <div class="stat-box-row">
                <span class="stat-label">ğŸ¤¡ å¤§å†¤ç§(ç‹¬è¾“)</span>
                <span id="pd-big-loss" class="stat-val">0æ¬¡</span>
            </div>

            <div class="stat-box-row">
                <span class="stat-label" id="lbl-cool">ğŸ˜ çˆ½åˆ°äº†</span>
                <span id="pd-cool" class="stat-val">0æ¬¡</span>
            </div>
            <div class="stat-box-row">
                <span class="stat-label" id="lbl-bad">ğŸ˜­ è¾“éº»äº†</span>
                <span id="pd-bad" class="stat-val">0æ¬¡</span>
            </div>

            <div class="stat-box-row">
                <span class="stat-label" id="lbl-fish">ğŸŸ æ‘¸é±¼</span>
                <span id="pd-fish" class="stat-val">0æ¬¡</span>
            </div>
            <div class="stat-box-row">
                <span class="stat-label">ğŸ”¥ ç”Ÿæ¶¯å‚æˆ˜ç‡</span>
                <span id="pd-rate" class="stat-val">0%</span>
            </div>
        </div>
        
        <div class="divider-text">ğŸ“… æœˆåº¦å¤´è¡” (ç‹¬å æ¦œé¦–)</div>
        <div id="pd-badge-container" class="badge-list">
            </div>

        <div id="pd-admin-config" class="threshold-config">
            <div style="font-size:0.8rem; font-weight:700; color:#94a3b8; margin-bottom:6px; text-align:center">âš™ï¸ ç»Ÿè®¡é˜ˆå€¼è®¾ç½® (äº‘ç«¯åŒæ­¥)</div>
            <div class="config-row">
                <span>ğŸ˜ çˆ½ (>X)</span> <input type="number" id="cfg-cool" class="config-input" value="100">
            </div>
            <div class="config-row">
                <span>ğŸ˜­ æƒ¨ (<-X)</span> <input type="number" id="cfg-bad" class="config-input" value="100">
            </div>
            <div class="config-row">
                <span>ğŸŸ é±¼ (|x|<X)</span> <input type="number" id="cfg-fish" class="config-input" value="5">
            </div>
            <button class="btn" style="width:100%; margin-top:8px; font-size:0.8rem" onclick="saveThresholds()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>

<div id="matchDetailModal" class="modal-overlay" style="z-index: 250;">
    <div class="modal-box">
        <div class="match-card-header">
            <div id="md-date" class="match-date">YYYY-MM-DD</div>
            <div id="md-room" class="match-room">Room: 123</div>
        </div>
        <div id="md-list" class="match-player-list"></div>
        <button class="btn outline" style="width:100%; margin-top:15px" onclick="document.getElementById('matchDetailModal').style.display='none'">å…³é—­</button>
    </div>
</div>

<div id="loginModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-hero">
            <div class="modal-icon" id="loginIcon">ğŸ”</div>
            <div class="modal-title" id="loginTitle">ç®¡ç†å‘˜ç™»å½•</div>
            <div class="modal-desc" id="loginDesc">è¯·è¾“å…¥ç³»ç»Ÿç®¡ç†å¯†ç </div>
        </div>
        <input type="password" id="loginInput" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') submitLogin()">
        <div class="modal-btns">
            <button class="btn" style="flex:1; padding:12px;" onclick="submitLogin()">è¿›å…¥</button>
            <button class="btn outline" style="flex:1; padding:12px;" onclick="closeLoginModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="customAlert" class="modal-overlay" style="z-index: 300;">
    <div class="modal-box" style="text-align:center">
        <div class="modal-hero">
            <div class="modal-icon" id="alertIcon"></div>
            <div class="modal-title" id="alertTitle"></div>
            <div class="modal-desc" id="alertBody"></div>
        </div>
        <div class="modal-btns">
            <button class="btn" style="width:100%" onclick="closeCustomAlert()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<div id="aliasModal" class="modal-overlay">
    <div class="modal-box" style="max-width:480px">
        <div class="modal-title">åˆå¹¶ç©å®¶</div>
        <div id="aliasList"></div>
        <button class="btn outline" style="width:100%; margin-top:10px; border-style:dashed" onclick="addAliasRow()">+ æ·»åŠ ä¸€è¡Œ</button>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="saveAliases()">ä¿å­˜</button>
            <button class="btn outline" style="flex:1" onclick="toggleAliasModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    console.log('Ver: v8.26');
    let globalRecords = [];
    let playerAliases = {}; 
    let currentFilter = 'week'; 
    let anchorDate = dayjs();
    let currentPage = 1;
    let pageSize = 10;
    let myChart = null;
    let globalActiveStats = {}; 
    let periodStats = {};       
    let currentPlayerDetailData = { maxWinRecord: null, maxLossRecord: null, playerName: '' };
    let thresholds = { cool: 100, bad: 100, fish: 5 };

    window.addEventListener('load', () => {
        if (window.dayjs_plugin_isoWeek) dayjs.extend(window.dayjs_plugin_isoWeek);
        if (window.dayjs_plugin_isoWeekYear) dayjs.extend(window.dayjs_plugin_isoWeekYear);
        
        checkAuthUI();
        updateDateDisplay();
        initData(); 
        setInterval(() => initData(true), 600000); 
    });

    // ... (æ‰‹åŠ¨å½•å…¥/ç¼–è¾‘é€»è¾‘ä¿æŒä¸å˜) ...
    function openManualAddModal(editRecord = null) {
        const list = document.getElementById('manualPlayerList');
        list.innerHTML = '';
        document.getElementById('editRecordId').value = '';
        const datalist = document.getElementById('playerOptions');
        datalist.innerHTML = '';
        const allNames = new Set();
        globalRecords.forEach(r => r.players.forEach(p => allNames.add(getRealName(p.name))));
        allNames.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            datalist.appendChild(opt);
        });

        if (editRecord) {
            document.getElementById('manualModalTitle').innerText = "âœï¸ ç¼–è¾‘æˆ˜ç»©";
            document.getElementById('editRecordId').value = editRecord.id;
            document.getElementById('manualDate').value = dayjs(editRecord.play_date).format('YYYY-MM-DDTHH:mm');
            document.getElementById('manualRoomId').value = editRecord.room_id || 'Manual';
            editRecord.players.forEach(p => addManualRow(p.name, p.score));
        } else {
            document.getElementById('manualModalTitle').innerText = "âœï¸ æ‰‹åŠ¨å½•å…¥æˆ˜ç»©";
            document.getElementById('manualDate').value = dayjs().format('YYYY-MM-DDTHH:mm');
            document.getElementById('manualRoomId').value = 'Manual';
            for(let i=0; i<4; i++) addManualRow();
        }
        updateManualSum();
        document.getElementById('manualAddModal').style.display = 'flex';
    }

    function addManualRow(nameVal = '', scoreVal = '') {
        const div = document.createElement('div');
        div.className = 'manual-row';
        div.innerHTML = `
            <input class="name" placeholder="ç©å®¶æ˜µç§°" list="playerOptions" value="${nameVal}">
            <input class="score" type="number" placeholder="åˆ†æ•°" oninput="updateManualSum()" value="${scoreVal}">
            <button class="del-btn" onclick="this.parentElement.remove();updateManualSum()">âœ•</button>
        `;
        document.getElementById('manualPlayerList').appendChild(div);
    }

    function updateManualSum() {
        const scores = document.querySelectorAll('#manualPlayerList .score');
        let sum = 0;
        scores.forEach(input => sum += (parseInt(input.value) || 0));
        const checkEl = document.getElementById('manualSumCheck');
        checkEl.innerText = `å½“å‰æ€»åˆ†: ${sum}`;
        checkEl.className = sum === 0 ? 'sum-check ok' : 'sum-check error';
    }

    // v8.16: æ­£è§„å†›å†™æ³•ï¼šç¼–è¾‘æ—¶èµ° PUTï¼Œæ–°å¢èµ° POST
    async function submitManualAdd() {
        const dateVal = document.getElementById('manualDate').value;
        const roomIdVal = document.getElementById('manualRoomId').value.trim() || 'Manual';
        const editId = document.getElementById('editRecordId').value;

        if (!dateVal) return showAlert("é”™è¯¯", "è¯·é€‰æ‹©æ—¥æœŸ", "âš ï¸");
        
        const rows = document.querySelectorAll('#manualPlayerList .manual-row');
        const players = [];
        let sum = 0;

        for (let row of rows) {
            const name = row.querySelector('.name').value.trim();
            const scoreStr = row.querySelector('.score').value.trim();
            if (!name) continue; 
            if (!scoreStr) return showAlert("é”™è¯¯", "è¯·è¾“å…¥åˆ†æ•°", "âš ï¸");
            const score = parseInt(scoreStr);
            sum += score;
            players.push({ name, score });
        }

        if (players.length < 2) return showAlert("é”™è¯¯", "è‡³å°‘éœ€è¦2åç©å®¶", "âš ï¸");
        if (sum !== 0) {
            if (!confirm(`âš ï¸ å½“å‰æ€»åˆ†ä¸ä¸º 0 (æ€»åˆ† ${sum})ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`)) return;
        }

        const payload = {
            game_name: "Mahjong",
            play_date: new Date(dateVal).toISOString(),
            room_id: roomIdVal, 
            room_info: editId ? "ç®¡ç†å‘˜ç¼–è¾‘" : "ç®¡ç†å‘˜æ‰‹åŠ¨å½•å…¥",
            players: players
        };

        try {
            if (editId) {
                // æ­£è§„ PUT æ¥å£
                await apiCall(`/records/${editId}`, 'PUT', payload);
                showAlert("æˆåŠŸ", "æˆ˜ç»©å·²æ›´æ–°", "âœ…");
            } else {
                await apiCall('/records', 'POST', payload);
                showAlert("æˆåŠŸ", "æˆ˜ç»©æ·»åŠ æˆåŠŸ", "âœ…");
            }
            document.getElementById('manualAddModal').style.display = 'none';
            await loadRecords(); 
            refreshUI();
        } catch(e) {
            showAlert("æ“ä½œå¤±è´¥", "æœåŠ¡å™¨æ¥å£å¼‚å¸¸: " + e.message, "âŒ");
        }
    }

    // --- v8.11 æ ¸å¿ƒï¼šæœˆåº¦è£èª‰(å«å¤§èµ¢å®¶)è®¡ç®— ---
    function calculateMonthlyBadges(targetName) {
        const monthGroups = {};
        globalRecords.forEach(rec => {
            const m = dayjs(rec.play_date).format('YYYY-MM');
            if (!monthGroups[m]) monthGroups[m] = [];
            monthGroups[m].push(rec);
        });

        const badges = { god: 0, noob: 0, worker: 0, fish: 0, bigwin: 0, bigloss: 0 };

        for (const [month, records] of Object.entries(monthGroups)) {
            const totalGamesInMonth = records.length;
            if (totalGamesInMonth === 0) continue;

            const pStats = {};
            records.forEach(rec => {
                rec.players.forEach(p => {
                    const name = getRealName(p.name);
                    if (!pStats[name]) pStats[name] = { wins: 0, count: 0, score: 0 };
                    pStats[name].count++;
                    pStats[name].score += p.score;
                    if (p.score > 0) pStats[name].wins++;
                });
            });

            let maxWR = -1, minWR = 101, maxPR = -1, minPR = 101, maxScore = -999999, minScore = 999999;
            for (const [name, s] of Object.entries(pStats)) {
                const wr = (s.wins / s.count) * 100;
                const pr = (s.count / totalGamesInMonth) * 100;
                const sc = s.score;

                if (wr > maxWR) maxWR = wr;
                if (wr < minWR) minWR = wr;
                if (pr > maxPR) maxPR = pr;
                if (pr < minPR) minPR = pr;
                if (sc > maxScore) maxScore = sc;
                if (sc < minScore) minScore = sc;
            }

            let counts = { maxWR: 0, minWR: 0, maxPR: 0, minPR: 0, maxScore: 0, minScore: 0 };
            for (const [name, s] of Object.entries(pStats)) {
                const wr = (s.wins / s.count) * 100;
                const pr = (s.count / totalGamesInMonth) * 100;
                const sc = s.score;

                if (Math.abs(wr - maxWR) < 0.01) counts.maxWR++;
                if (Math.abs(wr - minWR) < 0.01) counts.minWR++;
                if (Math.abs(pr - maxPR) < 0.01) counts.maxPR++;
                if (Math.abs(pr - minPR) < 0.01) counts.minPR++;
                if (sc === maxScore) counts.maxScore++;
                if (sc === minScore) counts.minScore++;
            }

            const myStat = pStats[targetName];
            if (myStat) {
                const myWR = (myStat.wins / myStat.count) * 100;
                const myPR = (myStat.count / totalGamesInMonth) * 100;
                const myScore = myStat.score;

                if (counts.maxWR === 1 && Math.abs(myWR - maxWR) < 0.01) badges.god++;
                if (counts.minWR === 1 && Math.abs(myWR - minWR) < 0.01) badges.noob++;
                if (counts.maxPR === 1 && Math.abs(myPR - maxPR) < 0.01) badges.worker++;
                if (counts.minPR === 1 && Math.abs(myPR - minPR) < 0.01) badges.fish++;
                if (counts.maxScore === 1 && myScore === maxScore) badges.bigwin++;
                if (counts.minScore === 1 && myScore === minScore) badges.bigloss++;
            }
        }
        return badges;
    }

    // --- ğŸ”¥ ç©å®¶è¯¦æƒ…é€»è¾‘ (v8.26) ğŸ”¥ ---
    function showPlayerDetails(name) {
        document.getElementById('pd-name').innerText = name;
        document.getElementById('lbl-cool').innerText = `ğŸ˜ çˆ½åˆ°äº† (>${thresholds.cool})`;
        document.getElementById('lbl-bad').innerText = `ğŸ˜­ è¾“éº»äº† (<${-thresholds.bad})`;
        document.getElementById('lbl-fish').innerText = `ğŸŸ æ‘¸é±¼ (|x|<${thresholds.fish})`;

        const stats = { maxWin: 0, maxLoss: 0, bigWinCount: 0, bigLossCount: 0, coolCount: 0, badCount: 0, fishCount: 0, totalScore: 0, gameCount: 0 };
        currentPlayerDetailData = { maxWinRecord: null, maxLossRecord: null, playerName: name };

        // å•æ—¥ç»Ÿè®¡é€»è¾‘
        const dailyStats = {}; // { '2025-01-01': 100 }

        globalRecords.forEach(rec => {
            const pRecord = rec.players.find(p => getRealName(p.name) === name);
            if (!pRecord) return;
            const score = pRecord.score;
            stats.totalScore += score;
            stats.gameCount++; 

            if (score > stats.maxWin) { stats.maxWin = score; currentPlayerDetailData.maxWinRecord = rec; }
            if (score < stats.maxLoss) { stats.maxLoss = score; currentPlayerDetailData.maxLossRecord = rec; }

            if (score >= thresholds.cool) stats.coolCount++;
            if (score <= -thresholds.bad) stats.badCount++;
            if (Math.abs(score) < thresholds.fish) stats.fishCount++;

            if (score > 0) {
                if (!rec.players.some(p => getRealName(p.name) !== name && p.score > 0)) stats.bigWinCount++;
            }
            if (score < 0) {
                if (!rec.players.some(p => getRealName(p.name) !== name && p.score < 0)) stats.bigLossCount++;
            }

            const dayKey = dayjs(rec.play_date).format('YYYY-MM-DD');
            if (!dailyStats[dayKey]) dailyStats[dayKey] = 0;
            dailyStats[dayKey] += score;
        });

        let bestDay = { date: '-', score: -999999 };
        let worstDay = { date: '-', score: 999999 };
        let hasData = false;

        for (const [date, score] of Object.entries(dailyStats)) {
            hasData = true;
            if (score > bestDay.score) bestDay = { date, score };
            if (score < worstDay.score) worstDay = { date, score };
        }

        const totalEl = document.getElementById('pd-total');
        totalEl.innerText = `ç”Ÿæ¶¯æ€»åˆ†: ${stats.totalScore > 0 ? '+' : ''}${stats.totalScore}`;
        totalEl.style.color = stats.totalScore > 0 ? '#ef4444' : (stats.totalScore < 0 ? '#10b981' : '#64748b');

        // æ›´æ–°å•å±€æ•°æ®
        document.getElementById('pd-max-win').innerText = `+${stats.maxWin}`;
        document.getElementById('pd-max-loss').innerText = stats.maxLoss;
        
        // ğŸ”¥ v8.26: å•æ—¥æ•°æ® (å·¦æ ‡é¢˜ï¼Œå³å‚ç›´æ•°æ®)
        if (hasData) {
            const bestDateStr = dayjs(bestDay.date).format('YY/MM/DD');
            const worstDateStr = dayjs(worstDay.date).format('YY/MM/DD');
            const bestScoreStr = bestDay.score > 0 ? `+${bestDay.score}` : bestDay.score;
            const worstScoreStr = worstDay.score > 0 ? `+${worstDay.score}` : worstDay.score;

            document.getElementById('pd-best-day').innerHTML = `<span class="pos stat-val">${bestScoreStr}</span><span class="stat-sub">${bestDateStr}</span>`;
            document.getElementById('pd-worst-day').innerHTML = `<span class="neg stat-val">${worstScoreStr}</span><span class="stat-sub">${worstDateStr}</span>`;
        } else {
            document.getElementById('pd-best-day').innerHTML = '<span class="stat-val">-</span>';
            document.getElementById('pd-worst-day').innerHTML = '<span class="stat-val">-</span>';
        }

        // æ›´æ–°åˆ—è¡¨æ•°æ® (v8.26: å·¦å³å¸ƒå±€)
        document.getElementById('pd-big-win').innerText = stats.bigWinCount + 'æ¬¡';
        document.getElementById('pd-big-loss').innerText = stats.bigLossCount + 'æ¬¡';
        document.getElementById('pd-cool').innerText = stats.coolCount + 'æ¬¡';
        document.getElementById('pd-bad').innerText = stats.badCount + 'æ¬¡';
        document.getElementById('pd-fish').innerText = stats.fishCount + 'æ¬¡';
        
        const totalGames = globalRecords.length;
        const rate = totalGames > 0 ? ((stats.gameCount / totalGames) * 100).toFixed(1) + '%' : '0%';
        document.getElementById('pd-rate').innerText = rate;

        // èšåˆæ ‡ç­¾å±•ç¤º
        const badges = calculateMonthlyBadges(name);
        let html = '';
        if (badges.god > 0) html += `<div class="s-tag tag-god" style="margin:2px"><span>ğŸ† ä½ æ˜¯æˆ‘çš„ç¥ x${badges.god}</span></div>`;
        if (badges.bigwin > 0) html += `<div class="s-tag tag-god" style="margin:2px"><span>ğŸ’° æŠŠä½ çš„é’±ç»™æˆ‘äº¤äº† x${badges.bigwin}</span></div>`;
        if (badges.worker > 0) html += `<div class="s-tag tag-worker" style="margin:2px"><span>ğŸ‘· åŠ³æ¨¡ x${badges.worker}</span></div>`;
        if (badges.noob > 0) html += `<div class="s-tag tag-noob" style="margin:2px"><span>ğŸ¥— èœå°±å¤šç»ƒ x${badges.noob}</span></div>`;
        if (badges.bigloss > 0) html += `<div class="s-tag tag-noob" style="margin:2px"><span>ğŸ’¸ è¯·æ‹¿èµ°æˆ‘çš„åº•è£¤ x${badges.bigloss}</span></div>`;
        if (badges.fish > 0) html += `<div class="s-tag tag-fish" style="margin:2px"><span>ğŸŸ æ‘¸é±¼ç‹ x${badges.fish}</span></div>`;
        
        document.getElementById('pd-badge-container').innerHTML = html || '<span style="color:#cbd5e1;font-size:0.8rem">æš‚æ— æœˆåº¦è£èª‰</span>';

        document.getElementById('cfg-cool').value = thresholds.cool;
        document.getElementById('cfg-bad').value = thresholds.bad;
        document.getElementById('cfg-fish').value = thresholds.fish;

        document.getElementById('playerDetailModal').style.display = 'flex';
    }

    // v8.17 ä¿®å¤ï¼šä½¿ç”¨ç´¢å¼•é”å®šï¼Œä¸å†ä¾èµ– ID
    function openEditRecord(index) {
        const record = globalRecords[index]; // ç›´æ¥é€šè¿‡æ•°ç»„ç´¢å¼•æ‹¿ï¼Œç»å¯¹ä¸ä¼šæ‰¾ä¸åˆ°
        if (!record) return showAlert("é”™è¯¯", "æ‰¾ä¸åˆ°è¯¥æˆ˜ç»©", "âŒ");
        openManualAddModal(record);
    }

    function openMatchDetail(type) {
        const rec = type === 'win' ? currentPlayerDetailData.maxWinRecord : currentPlayerDetailData.maxLossRecord;
        if (!rec) return showAlert("æ— æ•°æ®", "æš‚æ— è¯¥é¡¹è®°å½•", "ğŸ“­");

        document.getElementById('md-date').innerText = dayjs(rec.play_date).format('YYYYå¹´MMæœˆDDæ—¥ HH:mm');
        const roomDisplay = rec.room_id === 'Manual' ? 'ğŸŸï¸ çº¿ä¸‹å¯¹å±€' : (rec.room_id !== 'unknown' ? `æˆ¿é—´å·: ${rec.room_id}` : 'æˆ¿é—´å·: æœªçŸ¥');
        document.getElementById('md-room').innerText = roomDisplay;
        
        const listEl = document.getElementById('md-list');
        listEl.innerHTML = '';
        const sortedPlayers = [...rec.players].sort((a, b) => b.score - a.score);
        sortedPlayers.forEach(p => {
            const realName = getRealName(p.name);
            const isFocus = realName === currentPlayerDetailData.playerName;
            const scoreClass = p.score > 0 ? 'pos' : (p.score < 0 ? 'neg' : '');
            const div = document.createElement('div');
            div.className = `match-player-row ${isFocus ? 'focus' : ''}`;
            div.innerHTML = `<span>${escapeHtml(realName)}</span><span class="${scoreClass}">${p.score > 0 ? '+' : ''}${p.score}</span>`;
            listEl.appendChild(div);
        });
        document.getElementById('matchDetailModal').style.display = 'flex';
    }
    function closePlayerDetail() { document.getElementById('playerDetailModal').style.display = 'none'; }

    async function saveThresholds() {
        const cool = parseInt(document.getElementById('cfg-cool').value) || 100;
        const bad = parseInt(document.getElementById('cfg-bad').value) || 100;
        const fish = parseInt(document.getElementById('cfg-fish').value) || 5;
        thresholds = { cool, bad, fish };
        const payload = { ...playerAliases };
        payload['__META_THRESHOLDS__'] = JSON.stringify(thresholds);
        try {
            await apiCall('/aliases', 'POST', payload);
            showAlert("ä¿å­˜æˆåŠŸ", "é…ç½®å·²åŒæ­¥", "âœ…");
            showPlayerDetails(document.getElementById('pd-name').innerText);
        } catch (e) { showAlert("ä¿å­˜å¤±è´¥", e.message, "âŒ"); }
    }

    function onFilterChange(val) {
        anchorDate = dayjs();
        currentFilter = val;
        updateDateDisplay();
        refreshUI();
    }

    function showAlert(title, msg, icon='â„¹ï¸') {
        document.getElementById('alertIcon').innerText = icon;
        document.getElementById('alertTitle').innerText = title;
        document.getElementById('alertBody').innerText = msg;
        document.getElementById('customAlert').style.display = 'flex';
    }
    function closeCustomAlert() { document.getElementById('customAlert').style.display = 'none'; }

    function checkAuthUI() {
        const isAdmin = !!localStorage.getItem('mahjong_auth_token');
        document.getElementById('loginArea').style.display = !isAdmin ? 'block' : 'none';
        document.getElementById('adminControls').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('pd-admin-config').style.display = isAdmin ? 'block' : 'none';
    }

    function openLoginModal() {
        document.getElementById('loginInput').value = '';
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('loginInput').focus();
    }
    function closeLoginModal() { document.getElementById('loginModal').style.display = 'none'; }

    async function submitLogin() {
        const input = document.getElementById('loginInput').value;
        if (!input) return;
        try {
            const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-token': input } });
            if (res.ok) { 
                localStorage.setItem('mahjong_auth_token', input);
                closeLoginModal(); checkAuthUI(); refreshUI();
            } else { showAlert("ç™»å½•å¤±è´¥", "å¯†ç é”™è¯¯", "âŒ"); }
        } catch (e) { showAlert("é”™è¯¯", "éªŒè¯è¶…æ—¶", "âš ï¸"); }
    }

    function doLogout() { localStorage.removeItem('mahjong_auth_token'); checkAuthUI(); refreshUI(); }

    async function tryAction(actionCallback) {
        const savedToken = localStorage.getItem('mahjong_auth_token');
        if (savedToken) { await actionCallback(); return; }
        showAlert("æƒé™ä¸è¶³", "è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·", "ğŸ”");
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('mahjong_auth_token');
        if (token) headers['x-admin-token'] = token;
        const res = await fetch(`/api${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
        if (res.status === 401) { if(token) { localStorage.removeItem('mahjong_auth_token'); checkAuthUI(); throw new Error("AUTH_FAILED"); } }
        const contentType = res.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") === -1) {
            const text = await res.text();
            throw new Error("æœåŠ¡å™¨æ¥å£å¼‚å¸¸ (éJSONå“åº”)"); 
        }
        if (!res.ok) { 
            if (res.status === 409) throw new Error("DUPLICATE"); 
            const json = await res.json(); 
            throw new Error(json.error || 'è¯·æ±‚å¤±è´¥'); 
        }
        return res.json();
    }

    async function initData(isSilent = false) {
        if (!isSilent) showLoading(true);
        try { 
            await Promise.all([loadRecords(), loadAliases()]); 
            refreshUI(); 
        } catch (e) { 
            if (!isSilent) {
                document.getElementById('error-banner').style.display = 'block'; 
                document.getElementById('error-banner').innerText = "åŠ è½½å¤±è´¥ï¼š" + e.message; 
            }
        } finally { 
            if (!isSilent) showLoading(false); 
        }
    }
    
    async function loadRecords() { 
        let data = await apiCall('/records'); 
        data.sort((a, b) => new Date(b.play_date) - new Date(a.play_date));
        globalRecords = data;
        document.getElementById('totalCount').innerText = `å…± ${globalRecords.length} å±€`; 
    }
    
    async function loadAliases() {
        const data = await apiCall('/aliases');
        if (data['__META_THRESHOLDS__']) {
            try { thresholds = JSON.parse(data['__META_THRESHOLDS__']); delete data['__META_THRESHOLDS__']; } catch(e) {}
        }
        playerAliases = data;
    }

    async function saveAliases() {
        const keys = document.querySelectorAll('.alias-key');
        const vals = document.querySelectorAll('.alias-val');
        const newMap = {};
        keys.forEach((k, i) => { if(k.value.trim() && vals[i].value.trim()) newMap[k.value.trim()] = vals[i].value.trim(); });
        newMap['__META_THRESHOLDS__'] = JSON.stringify(thresholds);
        try { await apiCall('/aliases', 'POST', newMap); playerAliases = newMap; delete playerAliases['__META_THRESHOLDS__']; toggleAliasModal(); refreshUI(); showAlert("æˆåŠŸ", "åˆ«åå·²æ›´æ–°", "âœ…"); } 
        catch (e) { if (e.message === 'AUTH_FAILED') showAlert("å¤±è´¥", "æƒé™éªŒè¯å¤±è´¥", "âŒ"); else showAlert("å¤±è´¥", e.message, "âŒ"); }
    }

    async function safeHandleImport() {
        const inputEl = document.getElementById('rawInput');
        const text = inputEl.value.trim();
        if (!text) return showAlert("æç¤º", "å†…å®¹ä¸èƒ½ä¸ºç©º", "âš ï¸");
        const parsed = parseText(text);
        if (!parsed) return showAlert("é”™è¯¯", "æ ¼å¼æ— æ³•è¯†åˆ«", "âŒ");
        const isDuplicateLocal = globalRecords.some(r => r.room_id === parsed.roomId && dayjs(r.play_date).isSame(dayjs(parsed.date)));
        if (isDuplicateLocal) return showAlert("é‡å¤", "è¯¥æˆ˜ç»©å·²å­˜åœ¨", "âš ï¸");
        const btn = document.getElementById('uploadBtn');
        btn.disabled = true; btn.innerText = "ä¸Šä¼ ä¸­...";
        try {
            await apiCall('/records', 'POST', { game_name: parsed.gameName, play_date: parsed.date, room_info: parsed.roomInfo, room_id: parsed.roomId, players: parsed.players });
            showAlert("æˆåŠŸ", "æˆ˜ç»©å¯¼å…¥æˆåŠŸ", "âœ…"); inputEl.value = ''; await loadRecords(); refreshUI();
        } catch (e) {
            if (e.message === 'DUPLICATE') showAlert("é‡å¤", "è¯¥æˆ˜ç»©å·²å­˜åœ¨", "âš ï¸");
            else if (e.message === 'AUTH_FAILED') showAlert("å¤±è´¥", "å¯†ç é”™è¯¯", "âŒ");
            else showAlert("å‡ºé”™", e.message, "âŒ");
        } finally { btn.disabled = false; btn.innerHTML = "ğŸ“¥ è¯†åˆ«å¹¶å¯¼å…¥"; }
    }

    async function deleteRecord(recordId) {
        if (!confirm("âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æˆ˜ç»©å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ã€‚")) return;
        try {
            await apiCall(`/records/${recordId}`, 'DELETE');
            showAlert("æˆåŠŸ", "æˆ˜ç»©å·²åˆ é™¤", "âœ…"); await loadRecords(); refreshUI();
        } catch (e) { if (e.message === 'AUTH_FAILED') showAlert("å¤±è´¥", "æƒé™éªŒè¯å¤±è´¥", "âŒ"); else showAlert("å¤±è´¥", e.message, "âŒ"); }
    }

    function calculateStats(records) {
        const stats = {};
        const chronRecords = [...records].reverse();
        chronRecords.forEach(rec => {
            rec.players.forEach(p => {
                const name = getRealName(p.name);
                if (!stats[name]) stats[name] = { 
                    tempWinStreak: 0, tempLossStreak: 0, 
                    currentStreakType: 'none', currentStreakCount: 0, 
                    maxWinStreak: 0, maxLossStreak: 0 
                };
                const s = stats[name];
                if (p.score > 0) {
                    s.tempWinStreak++; s.tempLossStreak = 0; s.currentStreakType = 'win'; s.currentStreakCount = s.tempWinStreak;
                    if (s.tempWinStreak > s.maxWinStreak) s.maxWinStreak = s.tempWinStreak;
                } else {
                    s.tempLossStreak++; s.tempWinStreak = 0; s.currentStreakType = 'loss'; s.currentStreakCount = s.tempLossStreak;
                    if (s.tempLossStreak > s.maxLossStreak) s.maxLossStreak = s.tempLossStreak;
                }
            });
        });
        return stats;
    }

    function getBadgeHTML(type, count, isStatic = false) {
        if (count < 2) return '';
        let className = '', label = '';
        if (type === 'win') {
            if (count === 2) { className = 's-lv2'; label = 'äºŒè¿å‡»ç ´'; }
            else if (count === 3) { className = 's-lv3'; label = 'å¤§æ€ç‰¹æ€'; }
            else if (count === 4) { className = 's-lv4'; label = 'æ¥è¿‘æš´èµ°'; }
            else if (count === 5) { className = 's-lv5'; label = 'ä¸»å®°æ¯”èµ›'; }
            else if (count === 6) { className = 's-lv6'; label = 'æ— äººå¯æŒ¡'; }
            else if (count === 7) { className = 's-god'; label = 'æ¥è¿‘ç¥äº†'; }
            else if (count === 8) { className = 's-god'; label = 'æ— æ•Œè¶…ç¥!'; }
            else { className = 's-god'; label = `${count}è¿èƒœ, æ±‚æ±‚ä½ åšä¸ªäººå§!`; }
        } else {
            if (count === 2) { className = 'l-lv2'; label = 'åç‰¢ä¸­'; }
            else if (count === 3) { className = 'l-lv3'; label = 'æ•£è´¢ç«¥å­'; }
            else if (count === 4) { className = 'l-lv4'; label = 'æ…ˆå–„èµŒç‹'; }
            else if (count === 5) { className = 'l-lv5'; label = 'å†¥ç¯é«˜ç…§'; }
            else if (count === 6) { className = 'l-god'; label = 'ç ´äº§æ¸…ç®—'; }
            else if (count === 7) { className = 'l-god'; label = 'è¾“æ‰åº•è£¤äº†'; }
            else { className = 'l-god'; label = `${count}è¿è·ª, æ±‚æ±‚ä½ ä»¬è®©ä»–èµ¢ä¸€æŠŠå§!`; }
        }
        const staticClass = isStatic ? 's-static' : '';
        return `<div class="s-tag ${className} ${staticClass}"><span>${label}</span></div>`;
    }

    function refreshUI() { 
        globalActiveStats = calculateStats(globalRecords); 
        const filteredRecords = getFilteredRecords();
        periodStats = calculateStats(filteredRecords); 
        renderHistory(globalRecords); 
        renderStats(filteredRecords); 
        renderChart(); 
    }

    function renderStats(records) {
        const el = document.getElementById('statsTable');
        const stats = {};
        records.forEach(rec => {
            rec.players.forEach(p => {
                const name = getRealName(p.name);
                if (!stats[name]) stats[name] = { score: 0, count: 0, wins: 0 };
                stats[name].count++; stats[name].score += p.score; if (p.score > 0) stats[name].wins++;
            });
        });
        const sorted = Object.entries(stats).map(([k, v]) => ({ name: k, ...v })).sort((a, b) => b.score - a.score);
        
        if (sorted.length === 0) { el.innerHTML = '<div style="text-align:center;padding:20px;color:#999">è¯¥æ—¶æ®µæ— æ•°æ®</div>'; return; }
        
        let maxWR = -1, minWR = 101, maxPR = -1, minPR = 101;
        const totalPeriodGames = records.length;
        const counts = { maxWR: 0, minWR: 0, maxPR: 0, minPR: 0 };
        sorted.forEach(p => {
            if (p.count === 0) return;
            const wr = (p.wins / p.count) * 100;
            const pr = (p.count / totalPeriodGames) * 100;
            if (wr > maxWR) maxWR = wr;
            if (wr < minWR) minWR = wr;
            if (pr > maxPR) maxPR = pr;
            if (pr < minPR) minPR = pr;
        });
        sorted.forEach(p => {
            if (p.count === 0) return;
            const wr = (p.wins / p.count) * 100;
            const pr = (p.count / totalPeriodGames) * 100;
            if (Math.abs(wr - maxWR) < 0.01) counts.maxWR++;
            if (Math.abs(wr - minWR) < 0.01) counts.minWR++;
            if (Math.abs(pr - maxPR) < 0.01) counts.maxPR++;
            if (Math.abs(pr - minPR) < 0.01) counts.minPR++;
        });

        const recordTitle = 'æˆå°±'; 

        let tableHtml = `<table><thead><tr><th>ç©å®¶</th><th>æ€»åˆ†</th><th>å±€æ•°</th><th>èƒœç‡</th><th>å‚æˆ˜ç‡</th><th>${recordTitle}</th></tr></thead><tbody>`;
        sorted.forEach((p, idx) => {
            const scoreClass = p.score > 0 ? 'pos' : (p.score < 0 ? 'neg' : '');
            const scoreStr = p.score > 0 ? `+${p.score}` : p.score;
            const winRateNum = p.count > 0 ? (p.wins / p.count) * 100 : 0;
            const winRateStr = winRateNum.toFixed(1) + '%';
            const partRateNum = totalPeriodGames > 0 ? (p.count / totalPeriodGames) * 100 : 0;
            const partRateStr = partRateNum.toFixed(1) + '%';

            let historyHtml = '<div style="display:flex;gap:4px;flex-wrap:wrap">';
            
            const pStat = periodStats[p.name] || { maxWinStreak:0, maxLossStreak:0 };
            if (pStat.maxWinStreak >= 2) historyHtml += getBadgeHTML('win', pStat.maxWinStreak, true);
            if (pStat.maxLossStreak >= 2) historyHtml += getBadgeHTML('loss', pStat.maxLossStreak, true);
            
            if (p.count > 0) {
                if (counts.maxWR === 1 && Math.abs(winRateNum - maxWR) < 0.01) historyHtml += '<div class="s-tag tag-god"><span>ğŸ† ä½ æ˜¯æˆ‘çš„ç¥</span></div>';
                if (counts.minWR === 1 && Math.abs(winRateNum - minWR) < 0.01) historyHtml += '<div class="s-tag tag-noob"><span>ğŸ¥— èœå°±å¤šç»ƒ</span></div>';
                if (counts.maxPR === 1 && Math.abs(partRateNum - maxPR) < 0.01) historyHtml += '<div class="s-tag tag-worker"><span>ğŸ‘· åŠ³æ¨¡</span></div>';
                if (counts.minPR === 1 && Math.abs(partRateNum - minPR) < 0.01) historyHtml += '<div class="s-tag tag-fish"><span>ğŸŸ æ‘¸é±¼ç‹</span></div>';
            }

            historyHtml += '</div>';
            if(historyHtml === '<div style="display:flex;gap:4px;flex-wrap:wrap"></div>') historyHtml = '<span style="color:#cbd5e1">-</span>';

            const gActive = globalActiveStats[p.name] || { currentStreakType:'none', currentStreakCount:0 };
            const activeBadge = getBadgeHTML(gActive.currentStreakType, gActive.currentStreakCount, false);

            tableHtml += `<tr>
                <td style="font-weight:500">
                    <div style="display:flex;align-items:center;flex-wrap:wrap">
                        <span class="clickable-name" onclick="showPlayerDetails('${escapeHtml(p.name)}')">${escapeHtml(p.name)}</span>
                        ${activeBadge}
                    </div>
                </td>
                <td class="score ${scoreClass}">${scoreStr}</td>
                <td style="color:#94a3b8">${p.count}</td>
                <td style="font-size:0.9rem">${winRateStr}</td>
                <td style="font-size:0.9rem; color:#64748b">${partRateStr}</td>
                <td>${historyHtml}</td>
            </tr>`;
        });
        tableHtml += '</tbody></table>';
        el.innerHTML = `<div class="table-wrapper">${tableHtml}</div>`;
    }

    function renderHistory(records) {
        const el = document.getElementById('historyList');
        el.innerHTML = '';
        if (records.length === 0) { el.innerHTML = '<div style="text-align:center;color:#999;padding:20px">æš‚æ— è®°å½•</div>'; return; }
        const total = Math.ceil(records.length / pageSize) || 1;
        if (currentPage > total) currentPage = total; if (currentPage < 1) currentPage = 1;
        document.getElementById('pageInput').value = currentPage;
        document.getElementById('totalPagesText').innerText = total;
        
        const latestRecordMap = {}; 
        for (const rec of globalRecords) {
            for (const p of rec.players) {
                const name = getRealName(p.name);
                if (!latestRecordMap[name]) {
                    latestRecordMap[name] = rec.id;
                }
            }
        }

        const start = (currentPage - 1) * pageSize;
        records.slice(start, start + pageSize).forEach(rec => {
            // v8.17: ä½¿ç”¨ç´¢å¼•å®šä½ï¼Œç¡®ä¿ç‚¹å‡»ä¸€å®šæœ‰æ•ˆ
            const globalIndex = globalRecords.indexOf(rec);

            let pHTML = '';
            rec.players.forEach(p => {
                const color = p.score > 0 ? '#ef4444' : '#10b981';
                let streakTag = '';
                
                const realName = getRealName(p.name);
                if (latestRecordMap[realName] === rec.id) {
                    const gActive = globalActiveStats[realName];
                    if (gActive) streakTag = getBadgeHTML(gActive.currentStreakType, gActive.currentStreakCount, false);
                }

                pHTML += `<span class="p-tag" style="color:${color}">${escapeHtml(realName)} ${p.score>0?'+':''}${p.score} ${streakTag}</span>`;
            });
            const div = document.createElement('div'); div.className = 'record-item';
            
            const isAdmin = !!localStorage.getItem('mahjong_auth_token');
            const delBtn = isAdmin ? `<button class="del-record-btn action-btn del-btn-icon" onclick="tryAction(() => deleteRecord('${rec.id}'))" title="åˆ é™¤">ğŸ—‘ï¸</button>` : '';
            // v8.17: ä¼ å…¥ Index è€Œä¸æ˜¯ ID
            const editBtn = isAdmin ? `<button class="action-btn edit-btn" onclick="tryAction(() => openEditRecord(${globalIndex}))" title="ç¼–è¾‘">âœï¸</button>` : '';

            let roomDisplay = '';
            if (rec.room_id === 'Manual') {
                roomDisplay = '<span class="tag-offline">ğŸŸï¸ çº¿ä¸‹</span>';
            } else if (rec.room_id !== 'unknown') {
                roomDisplay = `<span>æˆ¿:${escapeHtml(rec.room_id)}</span>`;
            }

            div.innerHTML = `<div class="record-meta"><span>${dayjs(rec.play_date).format('MM-DD HH:mm')}</span><div style="display:flex;align-items:center">${roomDisplay}${editBtn}${delBtn}</div></div><div class="player-tags">${pHTML}</div>`;
            el.appendChild(div);
        });
    }

    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const records = getFilteredRecords().reverse(); 
        const allPlayerNames = new Set();
        records.forEach(r => r.players.forEach(p => allPlayerNames.add(getRealName(p.name))));
        const playersList = Array.from(allPlayerNames);
        if (playersList.length === 0) { if(myChart) myChart.destroy(); return; }
        
        const datasets = playersList.map((name, index) => {
            const hue = (index * 137.508) % 360; 
            return { label: name, data: [0], borderColor: `hsl(${hue}, 70%, 50%)`, backgroundColor: 'transparent', borderWidth: 2, tension: 0.1, pointRadius: 0, pointHoverRadius: 4 };
        });
        
        const currentScores = {}; playersList.forEach(p => currentScores[p] = 0);
        const labels = [''];
        
        records.forEach(rec => {
            labels.push(dayjs(rec.play_date).format('MM-DD HH:mm'));
            const roundScores = {}; rec.players.forEach(p => roundScores[getRealName(p.name)] = p.score);
            playersList.forEach((player, idx) => {
                if (roundScores[player] !== undefined) currentScores[player] += roundScores[player];
                datasets[idx].data.push(currentScores[player]);
            });
        });
        
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } }, tooltip: { itemSort: (a, b) => b.raw - a.raw } }, scales: { x: { display: false }, y: { grid: { color: '#f1f5f9' } } } } });
    }

    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    function getRealName(rawName) { let name = rawName.replace(/\(æˆ¿ä¸»\)/g, '').trim(); return playerAliases[name] || name; }
    function parseText(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        if (lines.length < 5) return null;
        const gameName = lines[0]; const date = lines[1]; const roomLine = lines[2] || "";
        let roomId = "unknown"; const roomMatch = roomLine.match(/æˆ¿é—´å·[ï¼š:](\d+)/); if (roomMatch) roomId = roomMatch[1];
        if (!text.includes("======ç©å®¶æˆ˜ç»©======")) return null;
        const body = text.split("======ç©å®¶æˆ˜ç»©======")[1];
        const blocks = body.split('-----------------------------');
        const players = [];
        blocks.forEach(b => {
            const nameMatch = b.match(/æ˜µç§°ï¼š(.+)/); const scoreMatch = b.match(/ç§¯åˆ†ï¼š([+\-]?\d+)/);
            if (nameMatch && scoreMatch) players.push({ name: nameMatch[1].trim(), score: parseInt(scoreMatch[1], 10) });
        });
        if (players.length === 0) return null;
        return { gameName, date, roomInfo: roomLine, roomId, players };
    }
    
    function toggleAliasModal() { 
        if (localStorage.getItem('mahjong_guest_token')) { showAlert("æƒé™ä¸è¶³", "æ¸¸å®¢æ¨¡å¼æ— æ³•ä¿®æ”¹åˆ«å", "â›”ï¸"); return; }
        const m = document.getElementById('aliasModal'); m.style.display = m.style.display==='flex'?'none':'flex'; if(m.style.display==='flex') renderAliasInputs(); 
    }
    function renderAliasInputs() {
        const c = document.getElementById('aliasList'); c.innerHTML = '';
        const list = Object.entries(playerAliases);
        if (list.length === 0) addAliasRow(); else list.forEach(([k, v]) => addAliasRow(k, v));
    }
    function addAliasRow(key = '', val = '') {
        const div = document.createElement('div'); div.className = 'alias-row';
        div.innerHTML = `<input class="alias-key" placeholder="åŸæ˜µç§°" value="${key}"><span>â¡</span><input class="alias-val" placeholder="åˆå¹¶å" value="${val}"><button class="del-btn" onclick="this.parentElement.remove()" title="åˆ é™¤">âœ•</button>`;
        document.getElementById('aliasList').appendChild(div);
    }
    function getFilteredRecords() {
        return globalRecords.filter(rec => {
            const rDate = dayjs(rec.play_date);
            if (currentFilter === 'all') return true;
            if (currentFilter === 'day') return rDate.isSame(anchorDate, 'day');
            if (currentFilter === 'week') return rDate.isoWeek ? rDate.isSame(anchorDate, 'isoWeek') : rDate.isSame(anchorDate, 'week');
            if (currentFilter === 'month') return rDate.isSame(anchorDate, 'month');
            if (currentFilter === 'year') return rDate.isSame(anchorDate, 'year');
            return false;
        });
    }
    function changeDate(delta) {
        if (currentFilter === 'all') return;
        if (currentFilter === 'day') anchorDate = anchorDate.add(delta, 'day');
        if (currentFilter === 'week') anchorDate = anchorDate.add(delta * 7, 'day');
        if (currentFilter === 'month') anchorDate = anchorDate.add(delta, 'month');
        if (currentFilter === 'year') anchorDate = anchorDate.add(delta, 'year');
        updateDateDisplay(); refreshUI();
    }
    function updateDateDisplay() {
        const el = document.getElementById('dateDisplay');
        try {
            if (currentFilter === 'all') el.innerText = 'å…¨éƒ¨æ—¶é—´';
            else {
                const yy = anchorDate.format('YY');
                if (currentFilter === 'day') el.innerText = anchorDate.format('YY-MM-DD');
                else if (currentFilter === 'week') {
                    if (anchorDate.isoWeekYear && anchorDate.isoWeek) {
                        const s = anchorDate.startOf('isoWeek').format('MM.DD'); 
                        const e = anchorDate.endOf('isoWeek').format('MM.DD');
                        const shortYear = anchorDate.isoWeekYear() % 100;
                        el.innerText = `${shortYear}å¹´${anchorDate.isoWeek()}å‘¨ (${s}-${e})`; 
                    } else el.innerText = anchorDate.format('YY-MM-DD');
                } 
                else if (currentFilter === 'month') el.innerText = anchorDate.format('YYå¹´MMæœˆ');
                else if (currentFilter === 'year') el.innerText = anchorDate.format('YYå¹´');
            }
        } catch(e) { el.innerText = anchorDate.format('YYYY-MM-DD'); }
    }
    function changePage(delta) {
        const totalPages = Math.ceil(globalRecords.length / pageSize) || 1;
        const next = currentPage + delta;
        if (next >= 1 && next <= totalPages) { currentPage = next; renderHistory(globalRecords); }
    }
    function jumpToPage() {
        const input = document.getElementById('pageInput'); let val = parseInt(input.value);
        const totalPages = Math.ceil(globalRecords.length / pageSize) || 1;
        if (isNaN(val) || val < 1) val = 1; if (val > totalPages) val = totalPages;
        currentPage = val; renderHistory(globalRecords); if (input.value != val) input.value = val;
    }
</script>
</body>
</html>